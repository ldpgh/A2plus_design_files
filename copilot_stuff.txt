Context ist FreeCAD 1.x mit Assembly2+ in der aktuellen Version
von  https://github.com/kbwbe/A2plus
und dem File https://github.com/kbwbe/A2plus/blob/master/a2p_importpart.py

Ziel ist beim Instanziieren eines andere FCStd-Objects einen Parameter
mitgeben, um die Groesse des Wuerfels eine Hierarchie weiter oben festzulegen.
Die Parameter befinden sich einem Spreadsheet mit Label=Parameters, welches
im aufgerufenen FCStd-Object liegt.

Es ist dafuer die Funktion   importPartFromFile    in  a2p_importpart.py
zu modifizieren. Verwende aber dafuer als Basis mein aktuelle Implementierung
der Funktion    importPartFromFile
Diese beihaltet schon das Verwenden des Spreadsheets mit den Parametern
und fuegt diese dem neu eingefuegten Object an.
Meine Implementierung von   importPartFromFile   kommt mir der naechsten 
Eingabe

"def importPartFromFile(
        _doc,
        filename,
        extractSingleShape = False, # load only a single user defined shape from file
        desiredShapeLabel = None,
        importToCache = False,
        cacheKey = "",
### lutz_dd, 2025_12_12
        instanceParameters = None
        ):
    doc = _doc
    #-------------------------------------------
    # Get the importDocument
    #-------------------------------------------

    # look only for filenames, not paths, as there are problems on WIN10 (Address-translation??)
    importDoc = None
    importDocIsOpen = False
    requestedFile = os.path.split(filename)[1]
    for d in FreeCAD.listDocuments().values():
        recentFile = os.path.split(d.FileName)[1]
        if requestedFile == recentFile:
            importDoc = d # file is already open...
            importDocIsOpen = True
            break

    if not importDocIsOpen:
        if filename.lower().endswith('.fcstd'):
            importDoc = FreeCAD.openDocument(filename)
        elif filename.lower().endswith('.stp') or filename.lower().endswith('.step'):
            import ImportGui
            fname =  os.path.splitext(os.path.basename(filename))[0]
            FreeCAD.newDocument(fname)
            newname = FreeCAD.ActiveDocument.Name
            FreeCAD.setActiveDocument(newname)
            ImportGui.insert(filename,newname)
            importDoc = FreeCAD.ActiveDocument
        else:
            msg = translate("A2plus", "A part can only be imported from a FreeCAD '*.FCStd' file")
            QtGui.QMessageBox.information( QtGui.QApplication.activeWindow(), translate("A2plus", "Value Error"), msg )
            return

### lutz_dd, 2025_12_12 ... start
    #-------------------------------------------
    # Instance-spezifische Parameter in Spreadsheet setzen (falls gewÃ¼nscht)
    #-------------------------------------------
    if instanceParameters:
        try:
            # Spreadsheet mit Label == "Parameters" suchen
            sheet = None
            for obj in importDoc.Objects:
                if obj.TypeId == "Spreadsheet::Sheet" and obj.Label == "Parameters":
                    sheet = obj
                    break
            if sheet:
                for key, value in instanceParameters.items():
                    try:
                        sheet.set(key, str(value))
                        FreeCAD.Console.PrintMessage(
                            f"[A2plus] Instanz-Parameter gesetzt: {key} = {value}\n"
                        )
                    except Exception as e:
                        FreeCAD.Console.PrintError(
                            f"[A2plus] Fehler beim Setzen von {key}: {e}\n"
                        )
                importDoc.recompute()
            else:
                FreeCAD.Console.PrintError(
                    "[A2plus] Kein Spreadsheet 'Parameters' im importierten Dokument gefunden.\n"
                )
        except Exception as e:
            FreeCAD.Console.PrintError("[A2plus] Ausnahme bei Instanz-Parameter:\n")
            FreeCAD.Console.PrintError(str(e) + "\n")
### lutz_dd, 2025_12_12 ... end

    #-------------------------------------------
    # recalculate imported part if requested by preferences
    # This can be useful if the imported part depends on an
    # external master-spreadsheet
    #-------------------------------------------
    if a2plib.getRecalculateImportedParts():
        for ob in importDoc.Objects:
            ob.recompute()
        importDoc.save() # useless without saving...

    #-------------------------------------------
    # Initialize the new TopoMapper
    #-------------------------------------------
    topoMapper = TopoMapper(importDoc)

    #-------------------------------------------
    # Get a list of the importable Objects
    #-------------------------------------------
    importableObjects = topoMapper.getTopLevelObjects(allowSketches=True)

    if len(importableObjects) == 0:
        msg = translate("A2plus", "No visible Part to import found. Aborting operation")
        QtGui.QMessageBox.information(
            QtGui.QApplication.activeWindow(),
            translate("A2plus", "Import Error"),
            msg
            )
        return

    #-------------------------------------------
    # if only one single shape of the importdoc is wanted..
    #-------------------------------------------
    labelList = []
    dc = DataContainer()

    if extractSingleShape:
        if desiredShapeLabel is None: # ask for a shape label
            for io in importableObjects:
                labelList.append(io.Label)
            dialog = a2p_shapeExtractDialog(
                QtGui.QApplication.activeWindow(),
                labelList,
                dc)
            dialog.exec_()
            if dc.tx is None:
                msg = translate("A2plus", "Import of a shape reference aborted by user")
                QtGui.QMessageBox.information(
                    QtGui.QApplication.activeWindow(),
                    translate("A2plus", "Import Error"),
                    msg
                    )
                return
        else: # use existent shape label
            dc.tx = desiredShapeLabel

    #-------------------------------------------
    # Discover whether we are importing a subassembly or a single part
    #-------------------------------------------
    subAssemblyImport = False
    if all([ 'importPart' in obj.Content for obj in importableObjects]) == 1:
        subAssemblyImport = True

    #-------------------------------------------
    # create new object
    #-------------------------------------------
    if importToCache:
        partName = 'CachedObject_'+str(objectCache.len())
        newObj = doc.addObject("Part::FeaturePython",partName)
        newObj.Label = partName
    else:
        partName = a2plib.findUnusedObjectName( importDoc.Label, document=doc )
        if extractSingleShape == False:
            partLabel = a2plib.findUnusedObjectLabel( importDoc.Label, document=doc )
        else:
            partLabel = a2plib.findUnusedObjectLabel(
                importDoc.Label,
                document=doc,
                extension=dc.tx
                )
        newObj = doc.addObject( "Part::FeaturePython", str(partName.encode('utf-8')) )    # works on Python 3.6.5
        newObj.Label = partLabel


    Proxy_importPart(newObj)

### lutz_dd, 2025_12_12 ... start
    #-------------------------------------------
    # Instanz-Parameter dauerhaft speichern
    #-------------------------------------------
    newObj.addProperty(
        "App::PropertyMap",
        "instanceParameters",
        "importPart",
        "Parameter overrides for this instance"
    )
    global mydebug
    mydebug=[newObj, instanceParameters]
    
    if instanceParameters:
        #HACK ... nur eine Element ... auf beliebige Anzahl noch erweitern
        param_name=list(instanceParameters)[0]
        newObj.instanceParameters = { param_name : "%r" % instanceParameters[param_name] }
### lutz_dd, 2025_12_12 ... end

    if FreeCAD.GuiUp:
        ImportedPartViewProviderProxy(newObj.ViewObject)

    newObj.a2p_Version = a2plib.getA2pVersion()
    assemblyPath = os.path.normpath(os.path.split(doc.FileName)[0])
    absPath = os.path.normpath(filename)
    if getRelativePathesEnabled():
        if platform.system() == "Windows":
            prefix = '.\\'
        else:
            prefix = './'
        relativePath = prefix+os.path.relpath(absPath, assemblyPath)
        newObj.sourceFile = relativePath
    else:
        newObj.sourceFile = absPath

    if dc.tx is not None:
        newObj.sourcePart = dc.tx

    newObj.setEditorMode("timeLastImport",1)
    newObj.timeLastImport = os.path.getmtime( filename )
    if a2plib.getForceFixedPosition():
        newObj.fixedPosition = True
    else:
        newObj.fixedPosition = not any([i.fixedPosition for i in doc.Objects if hasattr(i, 'fixedPosition') ])
    newObj.subassemblyImport = subAssemblyImport
    newObj.setEditorMode("subassemblyImport",1)

    if subAssemblyImport:
        if extractSingleShape:
            newObj.muxInfo, newObj.Shape, newObj.ViewObject.DiffuseColor, newObj.ViewObject.Transparency = \
                muxAssemblyWithTopoNames(importDoc,desiredShapeLabel = dc.tx)
        else:
            newObj.muxInfo, newObj.Shape, newObj.ViewObject.DiffuseColor, newObj.ViewObject.Transparency = \
                muxAssemblyWithTopoNames(importDoc)
    else:
        # TopoMapper manages import of non A2p-Files. It generates the shapes and appropriate topo names...
        if extractSingleShape:
            newObj.muxInfo, newObj.Shape, newObj.ViewObject.DiffuseColor, newObj.ViewObject.Transparency = \
                topoMapper.createTopoNames(desiredShapeLabel = dc.tx)
        else:
            newObj.muxInfo, newObj.Shape, newObj.ViewObject.DiffuseColor, newObj.ViewObject.Transparency = \
                topoMapper.createTopoNames()

    newObj.objectType = 'a2pPart'
    if extractSingleShape == True:
        if a2plib.isA2pSketch(newObj):
            newObj.objectType = 'a2pSketch'
    newObj.setEditorMode("objectType",1)

    doc.recompute()

    if importToCache: # this import is used to update already imported parts
        objectCache.add(cacheKey, newObj)
    else: # this is a first time import of a part
        if not a2plib.getPerFaceTransparency():
            # turn of perFaceTransparency by accessing ViewObject.Transparency and set to zero (non transparent)
            newObj.ViewObject.Transparency = 1
            newObj.ViewObject.Transparency = 0 # import assembly first time as non transparent.


    lcsList = a2p_lcs_support.getListOfLCS(doc,importDoc)


    if not importDocIsOpen:
        FreeCAD.closeDocument(importDoc.Name)

    if len(lcsList) > 0:
        #=========================================
        # create a group containing imported LCS's
        lcsGroupObjectName = 'LCS_Collection'
        lcsGroupLabel = translate("A2plus", "LCS_Collection")

        lcsGroup = doc.addObject( "Part::FeaturePython", str(lcsGroupObjectName.encode('utf-8')) )    # works on Python 3.6.5
        lcsGroup.Label = lcsGroupLabel

        a2p_lcs_support.LCS_Group(lcsGroup)
        a2p_lcs_support.VP_LCS_Group(lcsGroup.ViewObject)

        for lcs in lcsList:
            lcsGroup.addObject(lcs)

        lcsGroup.Owner = newObj.Name

        newObj.addProperty("App::PropertyLinkList","lcsLink","importPart").lcsLink = lcsGroup
        newObj.Label = newObj.Label # this is needed to trigger an update
        lcsGroup.Label = lcsGroup.Label

        #=========================================

    return newObj
"






Leider ist der Instanz-Parameter nur readonly.
Was muss geaendertz werden?





Maximal 10240 Zeichen bei Copy/Paste

Liste alle von mir gemachten Eingaben au ausser das Listing meines Files.
Es darf keinerlei Aenderung meiner Eingabe durch Dich erfolgen.

